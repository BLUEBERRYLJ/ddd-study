# 13장 실무에서의 도메인 주도 설계
그린필드 프로젝트와 브라운필드 프로젝트
- 브라운필드: 이미 비즈니스 가능성이 입증된 축적된 기술 부채에 맞서 대대적인 변화가 필요한 프로젝트
- 브라운필드 프로젝트에 DDD를 적용해보자.

### 전략적 분석
- DDD를 도입하기 위한 출발점:
    - 비즈니스 전략
    - 시스템 아키텍처 이해
    - 비즈니스 도메인 이해하기 : 하위 도메인, 고객, 서비스/가치, 경쟁 회사

#### 비즈니스 도메인 이해하기
- 휴리스틱
    - 회사 조직도 (부서, 조직 단위)
    - 조직의 협력

**하위 도메인 유형 찾기**
- 핵심 하위 도메인
    - 휴리스틱: 최악으로 설계된 소프트웨어 컴포넌트 찾기
    - 레거시 시스템을 상용 시스템으로 대체 불가, 수정시 비즈니스 위험 수반
- 일반 하위 도메인
    - 상용 솔루션, 연동 가능한 오픈소스 소프트웨어
- 지원 하위 도메인
    - 상용 솔루션으로 대체할 수 없지만 경쟁 우위를 제공하지 않는 컴포넌트
    - 자주 변경되지 않고, 최적으로 설계되지 않은 소프트웨어 설계라도 큰 영향이 없음
      전체 구조 식별 및 개발 중인 소프트웨어 시스템과 가장 관련있는 하위 도메인에 주의 기울이기


#### 현재 설계 탐색
- 문제 도메인 파악 후 이의 솔루션 및 설계 결정 살피기
- 상위 수준 컴포넌트부터 파악
    - 비즈니스 도메인을 하위 시스템으로 분해하는데 사용하는 경계 (바운디드 컨텍스트일 필요 X)
- 수명주기를 분리할 수 있는 컴포넌트 찾기
    - 하위 시스템이 하나의 git repo에서 관리되는 경우,
    - 모든 컴포넌트가 하나의 모놀리식 코드베이스에 있는 경우:
        - **어느 것이 다른 컴포넌트와 독립적으로 개선되고 테스트, 배포될 수 있는지 파악**

**전술적 설계 평가**
- 각 컴포넌트 별 비즈니스 로직 구현, 컴포넌트 아키텍처 정의에 사용된 패턴 파악
    - 해당 솔루션이 문제가 가지고 있는 복잡성을 해결하기에 적합한가?
    - 더 정교한 설계 패턴이 필요한 영역이 있는가?
    - 비용을 절약할 수 있는 방법이나 상용 솔루션을 사용할 수 있는 하위 도메인이 있는가?

위 질문을 던져보며 더 현명한 전략적, 전술적 의사결정 내리기

**전략적 설계 평가**
- 컴포넌트가 바운디드 컨텍스트인 것처럼 현재 설계의 컨텍스트 맵을 차트로 그려보기
- **바운디드 컨텍스트 연동 패턴** 관점에서 컴포넌트간 관계 식별하기
- 차트를 보며 최적이 아닌 전략적 설계 의사결정 파악

[E6F4C487-05C3-4947-85D6-C4A793829DE7_1_201_a.heic](..%2F..%2F..%2FPictures%2FPhotos%20Library.photoslibrary%2Fresources%2Frenders%2FE%2FE6F4C487-05C3-4947-85D6-C4A793829DE7_1_201_a.heic)
- 손실된 도메인 지식 찾기 -> 이벤트스토밍, 유비쿼터스 언어 만들기

### 현대화 전략
- 시스템을 현대화 시키기 위해 어디에 노력을 투자해야할까?
    - 시스템의 하위 도메인을 나누는 경계 찾기:
        - 프로젝트의 모듈, 패키지가 하위 도메인의 경계와 일치하는지 확인
    - **기술적 구현 패턴이 아닌 비즈니스 하위 도메인 경계를 반영하도록 바운디드 컨텍스트의 모듈을 재구성**
        - 시스템 모듈 조정은 비즈니스 로직 수정 포함 X, 더 잘 구성된 구조로 재배치하는것
        - DB 저장 프로시저 등 다른 코드베이스에서 구현된 하위 도메인의 비즈니스 로직 관리
        - 일부 로직이 DB 저장 프로시저에서 처리되는 경우, 해당 프로시저가 속한 모듈을 반영하도록 저장 프로시저 재배치

#### 전략적 현대화
논리적 경계를 물리적 경계로 전환하여 가장 많은 가치를 얻을 수 있는 곳 찾기 : 바운디드 컨텍스트 추출

질문
1. 여러 팀이 동일한 코드베이스에서 작업하고 있는가?
    - 각 팀에 대한 바운디드 컨텍스트 정의 -> 개발 수명주기 분리
2. 서로 다른 컴포넌트에서 충돌하는 모델을 사용하고 있는가?
    - 충돌하는 모델을 별도의 바운디드 컨텍스트로 재배치
3. 필요한 최소 바운디드 컨텍스트가 있는가?
    - 이들 간의 관계와 연동 패턴을 조사
    - 서로 다른 바운디드 컨텍스트에서 작업하는 팀이 어떻게 의사소통하고 협업하는지 확인
    - 각 팀이 바운디드 컨텍스트 통합 패턴을 통해 목표를 공유하고 적절한 협업을 하는가? 
    - 각 컨텍스트 통합 패턴이 해결할 수 있는 문제에 주목하라.
        - 사용자-제공자 관계, 충돌 방지 계층, 오픈 호스트 서비스, 분리형 노선
        ![5AF66213-73B9-4787-ABDF-7E13CEA0973E_1_102_a.jpeg](..%2F..%2F..%2FPictures%2FPhotos%20Library.photoslibrary%2Fresources%2Fderivatives%2F5%2F5AF66213-73B9-4787-ABDF-7E13CEA0973E_1_102_a.jpeg)

#### 전술적 현대화
- 비즈니스 가치와 구현 전략의 부조화 찾기
    - e.g) 모델의 복잡성에 부합하지 않는 패턴 (트랜잭션 스크립트, 액티브 레코드 패턴) 을 구현하는 핵심 하위 도메인
    - 좋지 않는 설계로 자주 변경되야 하는 컴포넌트의 유지보수와 개선이 어려움

#### 유비쿼터스 언어 육성
성공적인 현대화 : 비즈니스 도메인 지식과 비즈니스 도메인의 효과적인 모델 만들기 -> 유비쿼터스 언어 사용
- 이벤트스토밍으로 도메인 지식 수집, 유비쿼터스 언어 구축, 레거시 코드베이스 탐색
- 비즈니스 기능에 적합한 비즈니스 로직 구현 패턴 결정
    - 10장의 설계 휴리스틱 사용

---

#### 코드베이스 현대화 - 마이그레이션 방법
1. 전체 컴포넌트 (스트랭글러 패턴) 점진적 교체 또는
2. 기존 솔루션 점진적 리팩토링


1. **스트랭글러 패턴**
- 새로운 바운디드 컨텍스트인 스트랭글러 생성
    - 이를 사용해 새로운 요구사항 구현, 점차적으로 레거시 컨텍스트의 기능을 해당 컨텍스트로 마이그레이션
    - 동시에 레거시 바운디드 컨텍스트의 개선/개발 중지 -> 점점 커짐 -> 모든 기능 마이그레이션 및 레거시 코드베이스 제거
    - 클라이언트와 레거시/현대 컨텍스트 사이에 파사드 레이어 필요
    - 두 컨텍스트는 동일한 데이터로 작동 (바운디드 컨텍스트당 하나의 DB 규칙 완화)

2. **점진적 리팩토링**


1. 작은 점진적 조치가 대규모 재작성보다 안전하다.
    - 트랜잭션 스크립트를 이벤트 소싱으로 직접 리팩토링하지 마라.
        - 상태 기반 애그리게이트를 설계하는 중간 단계 진행
        - 효과적인 애그리게이트 경계를 찾는데 노력하기 (모든 관련 비즈니스 로직이 해당 경계 내에 있는지 확인)

2. 도메인 모델 패턴의 요소들을 점진적으로 도입해라.
    - 도메인 모델로의 리팩토링을 한 번에 할 필요는 없다.
        - 밸류 오브젝트부터 찾기 : 불변 객체 사용으로 솔루션 복잡성 줄이기 가능
        - 액티브 레코드 -> 애그리게이트 리팩토링: 단계적 진행
            - 일관성 있는 데이터에 작동하는 결정이 있는가?
            - 충분하게 일관성이 보장되는 경우 솔루션이 강한 일관성을 요구하는가?
            - 기술이 아닌 비즈니스에 좌우됨 -> 트랜잭션 요구사항 철저히 분석 후 애그리게이트 경계 설계하기

리팩토링 시
- 충돌 방지 계층 사용으로 이전 모델로부터 새 코드베이스 보호
- 오픈 호스트 서비스 구현, 공표된 언어 노출 : 레거시 코드베이스의 변경으로부터 사용자 보호

---

### 실용적인 도메인 주도 설계
- DDD의 모든 도구를 적용할 필요 X
- DDD는 애그리게이트나 밸류 오브젝트에 관한게 아니다.
- 비즈니스 도메인이 소프트웨어 설계 의사결정을 주도하게 하는 것

### 도메인 주도 설계 확산
- 리팩토링에 있어서 경영진을 설득하기 어렵다. 실무에 녹여내자.

#### 실무에 활용하는 도메인 주도 설계
- 도메인 주도 설계를 조직 전략이 아닌 실무에 활용하는 전문 도구 상자의 일부로 만들어라. (소프트웨어 엔지니어링 기법)

**일상 업무에 DDD를 통합하는 방법**
1. 유비쿼터스 언어
    - 이해관계자의 비즈니스 도메인 언어에 주목
    - 전문 용어가 아닌 비즈니스 의미를 반영한 용어로 만들기
    - 일치하지 않는 용어를 찾고, 설명 요청 및 이유를 명시적으로 만들기 (e.g: 동일한 항목에 대한 여러 이름)
    - 코드와 모든 프로젝트 관련 의사소통에 유비쿼터스 언어 사용하기

2. 바운디드 컨텍스트
- 분해 방법 탐색시 바운디드 컨텍스트를 나누는데 기반이 되는 원칙의 이유를 생각해보기
    - e.g.) 여러 팀이 동일한 코드베이스에서 작업하는것이 왜 나쁜 생각일까? 팀 간의 마찰, 협업에 방해되기 때문이다.

3. 전술적 설계 의사결정
- "DDD 책에서 그렇게 말하니까 여기에 애그리게이트를 사용하자!" 가 아닌 논리에 호소하라.
    - e.g) 명시적 트랜잭션 경계가 중요한 이유는 무엇일까? 데이터의 일관성을 보호하기 위해서다.
    - 왜 작은 애그리게이트 경계를 위해 노력해야할까? 넓은 트랜잭션 범위는 애그리게이트의 복잡성을 증가시키고 성능에 부정적인 영향을 주기 때문이다.
    - 이벤트 소싱 대신 이벤트를 로그 파일에 기록할 수 없는 이유는 무엇일까? 장기적으로 데이터 일관성이 보장되지 않기 때문이다.

**이벤트 소싱 도메인 모델**
- 도메인 모델 전문가에게 시간 차원에 관해 상태 기반 모델과 이벤트 기반 모델의 차이점과 이점을 설명하라. 스스로 설득당해 옹호할 것임.

---
**결론**
- 브라운필드도 그린필드 프로젝트와 마찬가지로 비즈니스 도메인 분석부터 시작하기
- 조직 구조와 기존 소프트웨어 설계 의사결정을 사용해 하위 도메인과 유형을 식별하기.
- 이 지식을 바탕으로 현대화 전략 계획하기.
- 대대적 재작성이 아닌 점진적으로 관련 컴포넌트를 리팩토링하거나 교체하며 레거시 코드 현대화 하기.
- DDD의 각 패턴 뒤에 있는 논리와 원칙을 사용해 DDD 도구 사용 및 동료를 설득하기






