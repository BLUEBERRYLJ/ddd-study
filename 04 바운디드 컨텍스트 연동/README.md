# 04 바운디드 컨텍스트 연동

- 바운디드 컨텍스트는 특정 문제를 해결하는 비즈니스 도메인의 모델입니다. 다른 바운디드 컨텍스트가 동일한 비즈니스 엔티티를 모델링할 수 있지만, 이는 다른 문제를 해결하기 위한 것입니다.
- 여러 바운디드 컨텍스트의 모델은 서로 독립적으로 발전할 수 있지만, 바운디드 컨텍스트 자체는 서로 상호작용해야 합니다.
- 이러한 접점을 컨트랙트라고 합니다.
- 바운디드 컨텍스트마다 모델과 언어의 차이가 있으므로 컨트랙트가 필요합니다.

## 협력형 패턴 그룹

### 파트너십 패턴

- 그때그때 대화를 통해 양방향으로 차이점을 해결하고 가장 적절한 솔루션을 선정합니다. 서로 컨트랙트에 필요한 언어를 특정 하나로 정의하거나 강요하지 않습니다.

적절한 상황

- 양 팀은 서로의 문제 해결에 협력적이어야 합니다.
- 잘 구축된 협업 실무, 높은 수준의 헌신, 팀간의 잦은 싱크, 지속적인 통합(CI)가 필요합니다.

부적절한 상황

- 소통이 원활하지 않을 때, 예컨대 서로 지리적으로 떨어져있는 팀에는 적절하지 않습니다.

### 공유 커널 패턴

- 서로 공유해야 하는 모델을 공통 소스코드로 작성해 공유합니다.
- 모노 레포지토리인 경우 같은 소스 파일을, 그렇지 않다면 라이브러리 형태로 내부 배포 합니다.
- 연쇄 변경의 영향을 최소화하려면 공유 커널은 최소화해야 합니다. 서로 연동될 수 있는 컨트랙트와 자료구조만으로 작게 구성하는 것이 이상적입니다.
- 공유 모델의 일관성을 유지하려면 영향받는 모든 바운디드 컨텍스트에 즉시 반영되어야 합니다. 어느 바운디드 컨텍스트에서 하위 버전의 공유 커널을 이용하면 문제가 발생할 수 있습니다. 지속적으로 통합하고, 연동 테스트를 수행해야 합니다.
- 각 팀에서 공유 커널을 함께 개발하는 경우가 흔하므로, 바운디드 컨텍스트의 단일 팀 원칙에는 위배됩니다. 일종의 실용적인 예외입니다.

적절한 상황

- 중복으로 인한 비용이 조율로 인한 비용보다 클 때 적용해야 합니다.
- 변경이 잦을 수록 중복 비용이 커집니다. 따라서 핵심 하위 도메인에 적용하기 좋습니다.
- 명분이 있어야 합니다. 팀 간 지리적 제약 또는 정치적 문제로, 커뮤니케이션이나 협업에 문제가 있으면 파트너십 패턴보다는 적절합니다.
- 한 팀에서 관리하는 둘 이상의 바운디드 컨텍스트를 연동하는 경우 잘 맞습니다. 두 바운디드 컨텍스트의 경계를 명시해주어, 시간이 흐를 수록 경계가 모호해주는 것을 막는데 데 도움을 줍니다.

## 사용자-제공자 패턴 그룹

- 업스트림: 서비스 제공자 (또는 팀)
- 다운스트림: 사용자 (또는 팀)

### 순응주의자 패턴

- 힘의 균형이 업스트림 팀에 있습니다. 사용자의 요구를 만족시킬 동기(모티베이션)이 없는 경우 등입니다.
- 다운스트림(사용자)는 순응하거나 떠나야 합니다.
- 외부 서비스 제공자와 연동하는 경우, 또는 정치적 이유로 발생할 수 있습니다.
- 다만 업스트림 팀이 노출한 컨트랙트가 산업 표준이거나, 잘 구축되었거나, 다운스트림의 요건은 어쨌든 만족했다면, 다운스트림 팀의 일부 자율성 포기는 어느 정도 정당화될 수 있습니다.

### 충돌 방지 계층 패턴

- 다운스트림의 바운디드 컨텍스트가 업스트림에 순응하지 않는다면, *다운스트림이* 충돌 방지 계층(ACL: anticorruption layer)을 두어 업스트림의 모델을 적절히 변환합니다.
- 다운스트림이 핵심 하위 도메인을 포함할 때, 업스트림 모델이 다운스트림의 요건에 비효율적이거나 불편할 때(특히 업스트림이 레거시 시스템일 때), 업스트림이 컨트랙트를 자주 변경할 때 적합합니다.

### 오픈 호스트 서비스 패턴

- 다운스트림에 힘이 있습니다.
- *업스트림이* 오픈 호스트 서비스(OHS: open-host service) 계층을 두어 인터페이스를 격리합니다. 이를 통해 다운스트림을 변경으로부터 보호합니다.
- OHS는 인터페이스 역할을 하며, 자신의 유비쿼터스 언어 대신 사용자에게 더 편리한 연동 지향 언어(integration-oriented language)를 따릅니다. 이때 사용하는 언어를 공표된 언어(public language)라고 합니다.
- OHS가 변환이 가능한 범위 내에서, 업스트림은 다운스트림 컨텍스트에 영향을 주지 않고 안전하게 변경할 수 있습니다.

## 분리형 노선

- 전혀 협업하지 않습니다. 중복되든 말든 각자 노선으로 갑니다.
- 조직 규모 또는 정치적 요인으로 커뮤니케이션이 어려운 경우일 수 있습니다. (유튜브에서 모 대기업 게임사가 이렇게 한다고 들었습니다)
- 일반 하위 도메인처럼 서비스 노출 없이 각자 연동해도 협업 비용보다 더 저렴한 경우일 수 있습니다.
- 모델이 서로 너무 다른 경우일 수 있습니다.

## 컨텍스트 맵

- 바운디드 컨텍스트간의 연동을 다이어그램으로 표현합니다.

장점

- 거시적 설계에 도움을 줍니다.
- 구성요소(조직)간 커뮤니케이션 패턴을 묘사할 수 있습니다. 쓸 일이 있을지도?
- 조직적인 문제에 대한 통찰력을 제시합니다. 조직의 전력을 ACL 구현에만 쏟는 다운스트림을 발견하거나, SPOF 팀을 발견할 수도 있습니다.

컨텍스트 맵의 유지보수

- 프로젝트 초기부터 도입하고, 바운디드 컨텍스트가 추가되거나 삭제되면 컨텍스트 맵을 업데이트하는 것이 이상적입니다.
- 각 팀이 자신이 담당하는 연동 현황을 갱신하면 좋습니다.
- [Context Mapper](https://contextmapper.org) 같은 도구를 이용해 코드로 관리할 수 있습니다.

한계

- 어렵습니다.
- 바운디드 컨텍스트가 여러 개의 하위 도메인을 가질 수 있습니다. 이 경우 여러 연동 패턴이 있을 수 있습니다.
