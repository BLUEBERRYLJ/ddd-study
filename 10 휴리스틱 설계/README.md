# 10 휴리스틱 설계

## 휴리스틱

- 검증된 규칙이 아닌,
- 완벽을 보장하지 않지만 목적 달성에는 충분한,
- 디테일(노이즈)를 무시하고 가장 중요한 단서에 집중하는,
- 경험적인 방법입니다.

## 바운디드 컨텍스트

최적의 크기

- 경계를 크기로 구분하는 것은 도움이 안 됩니다.
- 모델의 크기를 바꾸려 하지 말고, 모델의 크기 그대로 바운디드 컨텍스트를 다루는 것이 효과적입니다.

### 경계

- 하나의 변경 요청을 위해 여러 바운디드 컨텍스트를 바꿔야 한다면, 경계가 효과적이지 않다는 것입니다.
- 이러한 변경은 비싸고, 조율이 어렵습니다. 특히 해당 컨텍스트의 구현에 여러 팀이 관여한 경우 더욱 그렇습니다.
- 효과적이지 않은 경계를 리팩토링하는 것은 비용이 많이 듭니다. 심지어 방치되어 기술 부채로 남게 됩니다.

원인

- 비즈니스 도메인이 잘 알려져있지 않거나,
- 비즈니스 요구 사항이 빈번히 바뀔 때 발생합니다.
- 변동성 및 불확실성이 높은 핵심 하위 도메인, 특히 서비스 초기에 빈번합니다.

휴리스틱

- 바운디드 컨텍스트의 경계를 넓게 잡거나, 여러 하위 도메인에 걸쳐서 잡습니다.
- 모델이 잘못돼도 안전하게 해줍니다.
- 논리적 경계를 리팩토링하는 것이 물리적 경계를 리팩토링하는 것보다 저렴합니다.
- 나중에 도메인 지식이 축적되면 작은 여러 경계로 쪼갭시다.

## 비즈니스 로직 구현 패턴

4가지 비즈니스 로직 모델링 패턴의 특성에 따라, 1번부터 하나씩 질문해봅시다.

1. 금전 및 통화의 트랜잭션 추적, 일관된 audit log, 하위 도메인의 동작에 대한 심층적 분석이 요구된다면 -> 이벤트 소싱 도메인 모델
2. 비즈니스 로직이 복잡하다면 -> 도메인 모델
3. 자료구조가 복잡하다면 -> 액티브 레코드 패턴
4. 다 아니라면 -> 트랜잭션 스크립트

비즈니스 로직의 복잡성

- 단순함과 복잡함의 경계가 명확하지는 않지만, 몇 가지 휴리스틱이 있습니다.
  - 복잡한 비즈니스 로직은 복잡한 비즈니스 규칙, 불변성, 알고리즘을 포함합니다.
  - 로직의 입력값이 복잡한지를 통해 확인해볼 수 있습니다.
  - 유비쿼터스 언어 자체의 복잡성을 평가해봅시다. 언어가 CRUD만 의미하는지, 그 이상의 비즈니스 프로세스 및 규칙을 설명하는지 비교해봅시다.

하위 도메인의 유형 검토

- 하위 도메인 유형과 패턴 사이에 불일치가 있을 수도 있습니다.
  - 핵심 하위 도메인이라 생각했지만, 액티브 레코드나 트랜잭션 스크립트가 잘 맞는 경우가 있습니다.
  - 지원 하위 도메인이라 생각했지만, 도메인 모델이나 이벤트 소싱 도메인 모델이 잘 맞는 경우가 있습니다.
- 이를 기회로 삼고 하위 도메인과 비즈니스 도메인에 대한 추측 및 가정이 적절했는지 되돌아봅시다.
- 또한 핵심 하위 도메인의 경쟁력이 기술적인 것이 아닐 수도 있다는 점도 기억해둡시다. (기술적으로 단순할 수도 있습니다)

## 아키텍처 패턴

- 예외: 이벤트 소싱 모델을 안 쓰더라도, 하위 도메인이 여러 영속 모델에 있는 데이터를 표현해야 한다면 -> CQRS
- 이벤트 소싱 도메인 모델 -> CQRS
- 도메인 모델 -> 포트와 어댑터
- 액티브 레코드 패턴 -> 계층형 아키텍처 + 서비스 레이어, 총 4계층. 액티브 레코드 제어 로직을 위함입니다.
- 트랜잭션 스크립트 패턴 -> 3계층 최소한의 계층형 아키텍처

## 테스트 전략

피라미드형 테스트

- 유닛 테스트를 강조합니다. 통합 테스트는 별로 없고, E2E 테스트는 더더욱 없습니다.
- 애그리게이트와 밸류 오브젝트 도메인 모델 패턴을 잘 지원합니다. 두 패턴은 비즈니스 로직을 테스트하기 위한 완벽한 단위이기 때문입니다.

다이아몬드형 테스트

- 통합 테스트에 집중합니다.
- 액티브 레코드 패턴에 효과적입니다. 비즈니스 로직이 서비스 계층과 비즈니스 로직 계층에 흩어지기 때문입니다.

역전된 피라미드형 테스트

- E2E 테스트에 가장 많이 집중합니다.
- 트랜잭션 스크립트 패턴에 잘 어울립니다. 비즈니스 로직이 간단하고 계층의 수가 적기 때문입니다.

## 전술적 설계 의사결정 트리

책을 참고합시다 ㅎㅎ

- 이러한 휴리스틱이 100% 정확한 것은 아닙니다.
- 저자의 경험에 기반한 것입니다.
- 조직이 경험이 풍부하다면 모든 하위 도메인에 동일한 솔루션(고도의 패턴)을 적용할 수도 있습니다. 하지만 대체로는 휴리스틱 기반이 효과적이었습니다.
- 이 의사결정 트리는 가이드 규칙으로만 사용하고, 필요하다면 가이드 원칙을 개선하거나 자신만의 트리를 만듭시다.
